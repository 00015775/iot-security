<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Door System</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #0a0a0a;
      color: #e0e0e0;
      padding: 20px;
      line-height: 1.6;
    }
    
    .container { max-width: 1400px; margin: 0 auto; }
    
    header {
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      padding: 25px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #333;
    }
    
    h1 { color: #4CAF50; font-size: 28px; margin-bottom: 5px; }
    h2 { color: #4CAF50; font-size: 18px; margin-bottom: 15px; }
    h3 { color: #66BB6A; font-size: 16px; margin-bottom: 10px; }
    
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .card {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 20px;
    }
    
    .sensor-display {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: #0f0f0f;
      border-radius: 5px;
      margin: 10px 0;
      border: 1px solid #2d2d2d;
    }
    
    .sensor-label {
      color: #888;
      font-size: 14px;
    }
    
    .sensor-value {
      font-size: 24px;
      font-weight: bold;
      color: #4CAF50;
    }
    
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .status-on { background: #4CAF50; box-shadow: 0 0 8px #4CAF50; }
    .status-off { background: #f44336; }
    
    button {
      background: #2d2d2d;
      color: #e0e0e0;
      border: 1px solid #4CAF50;
      padding: 12px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
      transition: all 0.2s;
      min-width: 100px;
    }
    
    button:hover {
      background: #4CAF50;
      color: #000;
      transform: translateY(-2px);
    }
    
    button:active { transform: scale(0.98); }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    input, select {
      background: #2d2d2d;
      color: #e0e0e0;
      border: 1px solid #444;
      padding: 10px;
      border-radius: 5px;
      width: 100%;
      margin: 8px 0;
      font-size: 14px;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: #4CAF50;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    th {
      background: #2d2d2d;
      color: #4CAF50;
      padding: 12px;
      text-align: left;
      border-bottom: 2px solid #4CAF50;
      font-size: 14px;
    }
    
    td {
      padding: 10px 12px;
      border-bottom: 1px solid #333;
      font-size: 13px;
    }
    
    tr:hover { background: #1f1f1f; }
    
    .chart-container {
      height: 250px;
      margin-top: 15px;
      background: #0f0f0f;
      border: 1px solid #333;
      border-radius: 5px;
      padding: 15px;
      position: relative;
    }
    
    .stat-box {
      background: #0f0f0f;
      padding: 15px;
      border-radius: 5px;
      border: 1px solid #2d2d2d;
      text-align: center;
      margin: 10px 0;
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #4CAF50;
      display: block;
    }
    
    .stat-label {
      color: #888;
      font-size: 13px;
      margin-top: 5px;
    }
    
    .alert {
      background: #2d2d2d;
      border-left: 4px solid #4CAF50;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
    }
    
    .alert-warning { border-left-color: #ff9800; }
    .alert-danger { border-left-color: #f44336; }
    
    .connection-status {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .connected { background: #4CAF50; color: #000; }
    .disconnected { background: #f44336; color: #fff; }
    
    canvas {
      width: 100%;
      height: 100%;
    }
    
    label {
      display: block;
      color: #888;
      font-size: 13px;
      margin-top: 10px;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h1>Smart Door System</h1>
          <p>Real-time monitoring and control via USB</p>
        </div>
        <div>
          <button onclick="connectSerial()" id="connectBtn">Connect to Arduino</button>
          <span class="connection-status disconnected" id="statusBadge">Disconnected</span>
        </div>
      </div>
    </header>
    
    <div class="grid">
      <div class="card">
        <h2>Sensor Readings</h2>
        <div class="sensor-display">
          <div>
            <div class="sensor-label">Temperature</div>
            <div class="sensor-value" id="tempValue">--</div>
          </div>
        </div>
        <div class="sensor-display">
          <div>
            <div class="sensor-label">Humidity</div>
            <div class="sensor-value" id="humidityValue">--</div>
          </div>
        </div>
        <div class="sensor-display">
          <div>
            <div class="sensor-label">Distance</div>
            <div class="sensor-value" id="distanceValue">--</div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <h2>System Status</h2>
        <div class="sensor-display">
          <span><span class="status-indicator" id="doorIndicator"></span>Door</span>
          <span id="doorStatus">Closed</span>
        </div>
        <div class="sensor-display">
          <span><span class="status-indicator" id="fanIndicator"></span>Fan</span>
          <span id="fanStatus">Off</span>
        </div>
        <div class="sensor-display">
          <span><span class="status-indicator" id="irIndicator"></span>IR Sensor</span>
          <span id="irStatus">Clear</span>
        </div>
      </div>
      
      <div class="card">
        <h2>Quick Statistics</h2>
        <div class="stat-box">
          <span class="stat-value" id="avgTemp">0</span>
          <span class="stat-label">Average Temperature (°C)</span>
        </div>
        <div class="stat-box">
          <span class="stat-value" id="visitorCount">0</span>
          <span class="stat-label">Total Visitors Today</span>
        </div>
        <div class="stat-box">
          <span class="stat-value" id="failedAttempts">0</span>
          <span class="stat-label">Failed Attempts Today</span>
        </div>
      </div>
    </div>
    
    <div class="grid">
      <div class="card">
        <h2>Door Control</h2>
        <div class="button-group">
          <button onclick="sendCommand('open_door')">Open Door</button>
          <button onclick="sendCommand('close_door')">Close Door</button>
        </div>
      </div>
      
      <div class="card">
        <h2>Fan Control</h2>
        <div class="button-group">
          <button onclick="sendCommand('fan_on')">Turn On</button>
          <button onclick="sendCommand('fan_off')">Turn Off</button>
          <button onclick="sendCommand('fan_auto')">Auto Mode</button>
        </div>
      </div>
      
      <div class="card">
        <h2>LED Control</h2>
        <div class="button-group">
          <button onclick="sendCommand('led_red')">Blue</button>
          <button onclick="sendCommand('led_blue')">Red</button>
          <button onclick="sendCommand('led_off')">Auto</button>
        </div>
      </div>
      
      <div class="card">
        <h2>Buzzer Test</h2>
        <button onclick="sendCommand('buzzer')">Activate Buzzer</button>
      </div>
    </div>
    
    <div class="card">
      <h2>Temperature Trend (Last 30 Readings)</h2>
      <div class="chart-container">
        <canvas id="tempChart"></canvas>
      </div>
    </div>
    
    <div class="grid">
      <div class="card">
        <h2>Change Password</h2>
        <label>New Password (minimum 4 digits)</label>
        <input type="password" id="newPassword" placeholder="Enter new password" maxlength="10">
        <button onclick="changePassword()">Update Password</button>
      </div>
      
      <div class="card">
        <h2>System Settings</h2>
        <label>Temperature Threshold (°C)</label>
        <input type="number" id="tempThreshold" value="10">
        <button onclick="updateSetting('set_temp', 'tempThreshold')">Update</button>
        
        <label>Approach Distance (cm)</label>
        <input type="number" id="approachDist" value="50">
        <button onclick="updateSetting('set_approach', 'approachDist')">Update</button>
        
        <label>Door Distance (cm)</label>
        <input type="number" id="doorDist" value="15">
        <button onclick="updateSetting('set_door_dist', 'doorDist')">Update</button>
        
        <button onclick="resetSettings()" style="margin-top: 15px; border-color: #f44336;">Reset All Settings</button>
      </div>
    </div>
    
    <div class="card">
      <h2>Activity Log</h2>
      <div class="button-group">
        <button onclick="exportLogs('csv')">Export to CSV</button>
        <button onclick="exportLogs('json')">Export to JSON</button>
        <button onclick="clearLogs()">Clear Log</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>Timestamp</th>
            <th>Event</th>
            <th>Source</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody id="logTable">
          <tr><td colspan="4">No logs yet. Connect to Arduino to see activity.</td></tr>
        </tbody>
      </table>
    </div>
  </div>
  
  <script>
    // Serial connection
    let port;
    let reader;
    let writer;
    let connected = false;
    
    // Data storage
    let logs = [];
    let tempHistory = [];
    let sensorData = {
      temp: 0,
      humidity: 0,
      distance: 0,
      door: false,
      fan: false,
      ir: false
    };
    
    // Statistics
    let stats = {
      visitors: 0,
      failedAttempts: 0,
      tempSum: 0,
      tempCount: 0,
      maxTemp: 0,
      fanActivations: 0
    };
    
    // Chart setup
    let tempChart;
    
    // Connects to Arduino
    async function connectSerial() {
      try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 9600 });
        
        connected = true;
        document.getElementById('statusBadge').textContent = 'Connected';
        document.getElementById('statusBadge').className = 'connection-status connected';
        document.getElementById('connectBtn').textContent = 'Disconnect';
        document.getElementById('connectBtn').onclick = disconnectSerial;
        
        readSerial();
        
        // Request current settings
        setTimeout(() => sendCommand('get_settings'), 1000);
        
      } catch (error) {
        alert('Failed to connect: ' + error.message);
      }
    }
    
    // Disconnects from Arduino
    async function disconnectSerial() {
      if (reader) {
        await reader.cancel();
      }
      if (port) {
        await port.close();
      }
      connected = false;
      document.getElementById('statusBadge').textContent = 'Disconnected';
      document.getElementById('statusBadge').className = 'connection-status disconnected';
      document.getElementById('connectBtn').textContent = 'Connect to Arduino';
      document.getElementById('connectBtn').onclick = connectSerial;
    }
    
    // Read data from Arduino
    async function readSerial() {
      reader = port.readable.getReader();
      const decoder = new TextDecoder();
      let buffer = '';
      
      try {
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          
          buffer += decoder.decode(value, { stream: true });
          
          let newlineIndex;
          while ((newlineIndex = buffer.indexOf('\n')) !== -1) {
            const line = buffer.substring(0, newlineIndex).trim();
            buffer = buffer.substring(newlineIndex + 1);
            
            if (line) {
              processData(line);
            }
          }
        }
      } catch (error) {
        console.error('Read error:', error);
      } finally {
        reader.releaseLock();
      }
    }
    
    // Send command to Arduino
    async function sendCommand(cmd, value = null) {
      if (!connected) {
        alert('Please connect to Arduino first');
        return;
      }
      
      const command = { cmd: cmd };
      if (value !== null) {
        command.value = value;
      }
      
      const encoder = new TextEncoder();
      const writer = port.writable.getWriter();
      await writer.write(encoder.encode(JSON.stringify(command) + '\n'));
      writer.releaseLock();
    }
    
    // Process incoming data from Arduino
    function processData(line) {
      try {
        const data = JSON.parse(line);
        
        if (data.type === 'sensor') {
          updateSensorDisplay(data);
          updateTempChart(data.temp);
        } else if (data.type === 'log') {
          addLog(data);
        } else if (data.type === 'settings') {
          loadSettings(data);
        }
      } catch (error) {
        console.log('Non-JSON data:', line);
      }
    }
    
    // Update sensor display
    function updateSensorDisplay(data) {
      sensorData = data;
      
      document.getElementById('tempValue').textContent = data.temp.toFixed(1) + ' °C';
      document.getElementById('humidityValue').textContent = data.humidity.toFixed(0) + ' %';
      document.getElementById('distanceValue').textContent = data.distance + ' cm';
      
      document.getElementById('doorIndicator').className = 'status-indicator ' + (data.door ? 'status-on' : 'status-off');
      document.getElementById('doorStatus').textContent = data.door ? 'Open' : 'Closed';
      
      document.getElementById('fanIndicator').className = 'status-indicator ' + (data.fan ? 'status-on' : 'status-off');
      document.getElementById('fanStatus').textContent = data.fan ? 'On' : 'Off';
      
      document.getElementById('irIndicator').className = 'status-indicator ' + (data.ir ? 'status-on' : 'status-off');
      document.getElementById('irStatus').textContent = data.ir ? 'Triggered' : 'Clear';
      
      // Update statistics
      stats.tempSum += data.temp;
      stats.tempCount++;
      stats.maxTemp = Math.max(stats.maxTemp, data.temp);
      
      document.getElementById('avgTemp').textContent = (stats.tempSum / stats.tempCount).toFixed(1);
    }
    
    // Add log entry
    function addLog(data) {
      const timestamp = new Date().toLocaleTimeString();
      logs.unshift({
        time: timestamp,
        event: data.event,
        source: data.source,
        extra: data.extra
      });
      
      // Update statistics based on log
      if (data.event === 'door_unlock') {
        stats.visitors++;
        document.getElementById('visitorCount').textContent = stats.visitors;
      } else if (data.event === 'wrong_code') {
        stats.failedAttempts++;
        document.getElementById('failedAttempts').textContent = stats.failedAttempts;
      } else if (data.event === 'fan_on' && data.source === 'auto') {
        stats.fanActivations++;
      }
      
      // Keep only last 100 logs
      if (logs.length > 100) logs.pop();
      
      updateLogTable();
    }
    
    // Update log table
    function updateLogTable() {
      const table = document.getElementById('logTable');
      table.innerHTML = '';
      
      logs.forEach(log => {
        const row = table.insertRow();
        row.insertCell(0).textContent = log.time;
        row.insertCell(1).textContent = log.event;
        row.insertCell(2).textContent = log.source;
        row.insertCell(3).textContent = log.extra;
      });
    }
    
    // Update temperature chart
    function updateTempChart(temp) {
      tempHistory.push(temp);
      if (tempHistory.length > 30) tempHistory.shift();
      
      if (!tempChart) {
        const canvas = document.getElementById('tempChart');
        const ctx = canvas.getContext('2d');
        tempChart = ctx;
      }
      
      drawChart();
    }
    
    // Draw simple line chart
    function drawChart() {
      const canvas = document.getElementById('tempChart');
      const ctx = canvas.getContext('2d');
      const width = canvas.width = canvas.offsetWidth;
      const height = canvas.height = canvas.offsetHeight;
      
      ctx.clearRect(0, 0, width, height);
      
      if (tempHistory.length < 2) return;
      
      const padding = 40;
      const chartWidth = width - padding * 2;
      const chartHeight = height - padding * 2;
      
      const maxTemp = Math.max(...tempHistory, 30);
      const minTemp = Math.min(...tempHistory, 0);
      const tempRange = maxTemp - minTemp;
      
      // Draw axes
      ctx.strokeStyle = '#333';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(padding, padding);
      ctx.lineTo(padding, height - padding);
      ctx.lineTo(width - padding, height - padding);
      ctx.stroke();
      
      // Draw grid
      ctx.strokeStyle = '#222';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 5; i++) {
        const y = padding + (chartHeight / 5) * i;
        ctx.beginPath();
        ctx.moveTo(padding, y);
        ctx.lineTo(width - padding, y);
        ctx.stroke();
      }
      
      // Draw line
      ctx.strokeStyle = '#4CAF50';
      ctx.lineWidth = 3;
      ctx.beginPath();
      
      tempHistory.forEach((temp, i) => {
        const x = padding + (chartWidth / (tempHistory.length - 1)) * i;
        const y = height - padding - ((temp - minTemp) / tempRange) * chartHeight;
        
        if (i === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      });
      
      ctx.stroke();
      
      // Draw labels
      ctx.fillStyle = '#888';
      ctx.font = '12px Arial';
      ctx.fillText(maxTemp.toFixed(0) + '°C', 5, padding);
      ctx.fillText(minTemp.toFixed(0) + '°C', 5, height - padding);
      ctx.fillText('Time', width / 2, height - 10);
    }
    
    // Change password
    function changePassword() {
      const newPass = document.getElementById('newPassword').value;
      if (newPass.length < 4) {
        alert('Password must be at least 4 characters');
        return;
      }
      if (confirm('Change password to: ' + newPass + '?')) {
        sendCommand('set_password', newPass);
        document.getElementById('newPassword').value = '';
      }
    }
    
    // Update setting
    function updateSetting(cmd, inputId) {
      const value = parseInt(document.getElementById(inputId).value);
      if (isNaN(value)) {
        alert('Please enter a valid number');
        return;
      }
      sendCommand(cmd, value);
    }
    
    // Reset settings
    function resetSettings() {
      if (confirm('Reset all settings to defaults?')) {
        sendCommand('reset');
        document.getElementById('tempThreshold').value = 10;
        document.getElementById('approachDist').value = 50;
        document.getElementById('doorDist').value = 15;
      }
    }
    
    // Load settings from Arduino
    function loadSettings(data) {
      document.getElementById('tempThreshold').value = data.temp_threshold;
      document.getElementById('approachDist').value = data.approach_dist;
      document.getElementById('doorDist').value = data.door_dist;
    }
    
    // Export logs to CSV
    function exportLogs(format) {
      if (logs.length === 0) {
        alert('No logs to export');
        return;
      }
      
      let content;
      let filename;
      
      if (format === 'csv') {
        content = 'Timestamp,Event,Source,Details\n';
        logs.forEach(log => {
          content += `"${log.time}","${log.event}","${log.source}","${log.extra}"\n`;
        });
        filename = 'door_logs.csv';
      } else {
        content = JSON.stringify(logs, null, 2);
        filename = 'door_logs.json';
      }
      
      const blob = new Blob([content], { type: format === 'csv' ? 'text/csv' : 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }
    
    // Clear logs
    function clearLogs() {
      if (confirm('Clear all logs?')) {
        logs = [];
        updateLogTable();
      }
    }
    
    // Check for Web Serial API support
    if (!('serial' in navigator)) {
      alert('Web Serial API not supported. Please use Chrome, Edge, or Opera browser.');
    }
  </script>
</body>
</html>


<!-- 
Reference:

Code adapted from https://github.com/funnierinspanish/web-serial-example
Code adapted from https://github.com/kjj6198/web-serial-api?tab=readme-ov-file
Code adapted from https://www.makerspace-online.com/controlling-microcontrollers-over-usb-with-the-web-serial-api
Code adapted from https://github.com/svendahlstrand/web-serial-api
Information learned from https://foostack.ru/web-serial-api-arduino/
Code adapted from https://www.electronicsforu.com/electronics-projects/sensor-data-sending-over-web-serial
Code adapted from https://www.youtube.com/watch?v=a8UhkWDP-dI
Code adapted from https://www.youtube.com/watch?v=rkiDjfTt4T0

-->

